---
phase: 03-mid-format-fixes
plan: 02
type: execute
depends_on: []
files_modified: [open_protocol_emulator.py]
autonomous: true
---

<objective>
Fix tool control MID deviations from Phase 2 audit (MID 0040-0043).

Purpose: Add missing MID 0040/0041 notifications and fix misleading log messages.
Output: Tool enable/disable commands send proper notification MIDs after acknowledgment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mid-format-audit/02-01-AUDIT.md

@open_protocol_emulator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MID 0040 notification after tool disable (MID 0042)</name>
  <files>open_protocol_emulator.py</files>
  <action>
Per Open Protocol spec, when tool is disabled via MID 0042:
1. Controller sends MID 0005 (command accepted) acknowledging MID 0042
2. Controller sends MID 0040 (tool disabled notification) to inform integrator

Current implementation (lines 346-352) only sends MID 0005:
```python
elif mid_int == 42:
    print("[Tool] Received Request Tool Disable (MID 0042).")
    self.tool_enabled = False
    resp = build_message(5, rev=1, data="0042")
    self.send_to_client(resp)
    print("[Tool] Tool Disabled. Sent MID 0040 confirmation.")  # WRONG: says 0040 but sends 0005
    return
```

Fix to send both MID 0005 AND MID 0040:
```python
elif mid_int == 42:  # MID 0042 Disable Tool Request
    print("[Tool] Received Request Tool Disable (MID 0042).")
    self.tool_enabled = False
    # Send MID 0005 acknowledgment
    resp = build_message(5, rev=1, data="0042")
    self.send_to_client(resp)
    # Send MID 0040 notification
    notification = build_message(40, rev=1)
    self.send_to_client(notification)
    print("[Tool] Tool Disabled. Sent MID 0005 ack and MID 0040 notification.")
    return
```

MID 0040 has no data field in revision 1 (header only).
  </action>
  <verify>Search for "mid_int == 42" and verify both build_message(5, ...) and build_message(40, ...) are present</verify>
  <done>MID 0042 handler sends MID 0005 ack followed by MID 0040 notification</done>
</task>

<task type="auto">
  <name>Task 2: Add MID 0041 notification after tool enable (MID 0043)</name>
  <files>open_protocol_emulator.py</files>
  <action>
Same pattern as MID 0042 fix. Per Open Protocol spec, when tool is enabled via MID 0043:
1. Controller sends MID 0005 (command accepted) acknowledging MID 0043
2. Controller sends MID 0041 (tool enabled notification) to inform integrator

Current implementation (lines 353-359) only sends MID 0005:
```python
elif mid_int == 43:
    print("[Tool] Received Request Tool Enable (MID 0043).")
    self.tool_enabled = True
    resp = build_message(5, rev=1, data="0043")
    self.send_to_client(resp)
    print("[Tool] Tool Enabled. Sent MID 0041 confirmation.")  # WRONG: says 0041 but sends 0005
    return
```

Fix to send both MID 0005 AND MID 0041:
```python
elif mid_int == 43:  # MID 0043 Enable Tool Request
    print("[Tool] Received Request Tool Enable (MID 0043).")
    self.tool_enabled = True
    # Send MID 0005 acknowledgment
    resp = build_message(5, rev=1, data="0043")
    self.send_to_client(resp)
    # Send MID 0041 notification
    notification = build_message(41, rev=1)
    self.send_to_client(notification)
    print("[Tool] Tool Enabled. Sent MID 0005 ack and MID 0041 notification.")
    return
```

MID 0041 has no data field in revision 1 (header only).
  </action>
  <verify>Search for "mid_int == 43" and verify both build_message(5, ...) and build_message(41, ...) are present</verify>
  <done>MID 0043 handler sends MID 0005 ack followed by MID 0041 notification</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MID 0042 handler sends both MID 0005 and MID 0040
- [ ] MID 0043 handler sends both MID 0005 and MID 0041
- [ ] Log messages are accurate (no longer misleading)
- [ ] No syntax errors (python -m py_compile open_protocol_emulator.py)
</verification>

<success_criteria>

- All tasks completed
- Tool disable (MID 0042) sends notification (MID 0040) per spec
- Tool enable (MID 0043) sends notification (MID 0041) per spec
- Log messages match actual behavior
- Code compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/03-mid-format-fixes/03-02-SUMMARY.md`
</output>
