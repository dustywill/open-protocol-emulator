---
phase: 03-mid-format-fixes
plan: 01
type: execute
depends_on: []
files_modified: [open_protocol_emulator.py]
autonomous: true
---

<objective>
Fix critical and major parameter set MID deviations from Phase 2 audit.

Purpose: Bring MID 0015 and MID 0017 into full spec compliance.
Output: Corrected MID 0015 format with Date of Last Change field, implemented MID 0017 unsubscribe handler.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mid-format-audit/02-02-AUDIT.md

@open_protocol_emulator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix MID 0015 format - Add Date of Last Change field</name>
  <files>open_protocol_emulator.py</files>
  <action>
Fix MID 0015 (Parameter Set Selected) to include the required "Date of Last Change" field per Open Protocol spec.

Current implementation (two locations):
1. Lines 385-387 (in MID 0014 handler - subscription response)
2. Lines 370-372 (in MID 0018 handler - selection notification)

Current format:
```python
mid15_data = self.current_pset.rjust(3, '0')  # Only 3 bytes (Pset ID)
```

Required format per spec (Revision 1, total 22 bytes data):
- Position 20: Parameter Set ID (3 bytes, right-justified with zeros)
- Position 23: Date of Last Change (19 bytes, format "YYYY-MM-DD:HH:MM:SS")

Fix both locations to use:
```python
pset_id = self.current_pset.rjust(3, '0')
date_str = self.pset_last_change.strftime("%Y-%m-%d:%H:%M:%S") if self.pset_last_change else datetime.datetime.now().strftime("%Y-%m-%d:%H:%M:%S")
mid15_data = pset_id + date_str
```

The `pset_last_change` attribute already exists and is set in MID 0018 handler.

Consider creating a helper method `_build_mid15_data()` to avoid duplication.
  </action>
  <verify>
1. Run: python -c "import open_protocol_emulator; e = open_protocol_emulator.OpenProtocolEmulator(); print(len(e._build_mid15_data()) if hasattr(e, '_build_mid15_data') else 'manual check')"
2. Or manually verify the MID 0015 data generation produces 22-character data field
  </verify>
  <done>MID 0015 includes Pset ID (3 chars) + Date of Last Change (19 chars) = 22 chars data</done>
</task>

<task type="auto">
  <name>Task 2: Implement MID 0017 - Parameter Set Selected Unsubscribe</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add missing MID 0017 handler (Parameter Set Selected Unsubscribe).

Insert handler after MID 0016 acknowledgment handler (around line 392):

```python
elif mid_int == 17:  # MID 0017 Parameter set selected unsubscribe
    if self.pset_subscribed:
        self.pset_subscribed = False
        resp = build_message(5, rev=1, data="0017")  # Accept
        print("[Pset] Unsubscribed from Pset selection.")
    else:
        resp = build_message(4, rev=1, data="001707")  # Error: Not subscribed
    self.send_to_client(resp)
    return
```

Error code 07 = "Subscription doesn't exist" per Open Protocol spec.

This mirrors the existing MID 0054 (VIN unsubscribe) and MID 0063 (tightening unsubscribe) patterns.
  </action>
  <verify>
1. Search for "mid_int == 17" in the file to confirm handler exists
2. Verify error code format is "001707" (6 chars: 4-digit MID + 2-digit error)
  </verify>
  <done>MID 0017 handler implemented with proper success/error responses</done>
</task>

<task type="auto">
  <name>Task 3: Add Pset 0 selection support to MID 0018</name>
  <files>open_protocol_emulator.py</files>
  <action>
Per Open Protocol spec, selecting Pset 0 means "no parameter set selected" and should be allowed even if "0" is not in available_psets.

Current implementation (lines 363-376) rejects Pset 0 because it's not in available_psets:
```python
if pset_id in self.available_psets:
    # success
else:
    resp = build_message(4, rev=1, data="001802")  # Error: Pset not found
```

Modify to handle Pset 0 specially:
```python
elif mid_int == 18:  # MID 0018 Select Parameter set
    pset_id = data_field.strip()
    if pset_id == "0" or pset_id == "000":
        # Pset 0 = no parameter set selected
        self.current_pset = "0"
        self.pset_last_change = datetime.datetime.now()
        resp = build_message(5, rev=1, data="0018")  # Accept
        print("[Pset] No Pset selected (Pset 0).")
        if self.pset_subscribed:
            mid15_data = self._build_mid15_data()  # or inline the 22-char format
            mid15_msg = build_message(15, rev=1, data=mid15_data)
            self.send_to_client(mid15_msg)
            print(f"[Pset] Sent MID 0015: Pset 0")
    elif pset_id in self.available_psets:
        # existing success path
    else:
        # existing error path
```
  </action>
  <verify>Verify MID 0018 handler has explicit check for pset_id "0" or "000"</verify>
  <done>Pset 0 selection allowed and handled correctly (no error, sends MID 0015 notification)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MID 0015 data field is 22 characters (3 + 19)
- [ ] MID 0017 handler exists and returns MID 0005 on success, MID 0004 with error 07 on failure
- [ ] MID 0018 accepts Pset 0 selection
- [ ] No syntax errors (python -m py_compile open_protocol_emulator.py)
</verification>

<success_criteria>

- All tasks completed
- MID 0015 format matches spec (includes Date of Last Change)
- MID 0017 unsubscribe implemented
- MID 0018 handles Pset 0 selection
- Code compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/03-mid-format-fixes/03-01-SUMMARY.md`
</output>
