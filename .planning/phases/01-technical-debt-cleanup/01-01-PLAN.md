---
phase: 01-technical-debt-cleanup
plan: 01
type: execute
depends_on: []
files_modified: [open_protocol_emulator.py]
autonomous: true
---

<objective>
Fix duplicate method definition and replace bare except clauses with specific exception handling.

Purpose: Clean up critical code quality issues that hide bugs and could cause runtime errors.
Output: Cleaner error handling and removal of dead/broken code.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

@open_protocol_emulator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove duplicate _increment_vin() method</name>
  <files>open_protocol_emulator.py</files>
  <action>
Remove the first `_increment_vin()` method definition at lines 153-168. This is a copy-paste error - it contains the code from `_parse_vin()` but has the wrong docstring and references undefined variable `vin_string` (would cause NameError at runtime).

Keep only the second, correct implementation at lines 170-186 which properly increments the numeric part of the VIN.

The broken method (lines 153-168):
```python
def _increment_vin(self):
    """Parses VIN into prefix and numeric parts."""  # Wrong docstring
    match = re.match(r'^(.*?)(\d+)$', vin_string)  # undefined vin_string
    ...
```

The correct method to keep (lines 170-186):
```python
def _increment_vin(self):
    """Increments the numeric part of the VIN and updates the state."""
    try:
        numeric_val = int(self.vin_numeric_str)
        ...
```
  </action>
  <verify>
Run: `python -c "from open_protocol_emulator import OpenProtocolEmulator; e = OpenProtocolEmulator(); e._increment_vin(); print('VIN:', e.current_vin)"`
Should increment VIN from AB123000 to AB123001 without NameError.
  </verify>
  <done>Only one `_increment_vin()` method exists. Method increments VIN correctly without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Replace bare except clauses with specific exceptions</name>
  <files>open_protocol_emulator.py</files>
  <action>
Replace all 5 bare `except:` clauses with specific exception types. These are all socket close operations where we want to suppress expected errors but not hide unexpected ones.

1. **Line 212** (rejecting duplicate connection):
   ```python
   # Before: except: pass
   # After:
   except (OSError, BrokenPipeError):
       pass
   ```

2. **Line 234** (send_to_client OSError handling):
   ```python
   # Before: except: pass
   # After:
   except OSError:
       pass
   ```

3. **Line 240** (send_to_client unexpected error):
   ```python
   # Before: except: pass
   # After:
   except OSError:
       pass
   ```

4. **Line 271** (handle_client cleanup):
   ```python
   # Before: except: pass
   # After:
   except OSError:
       pass
   ```

5. **Line 310** (communication stop - MID 0003):
   ```python
   # Before: except: pass
   # After:
   except OSError:
       pass
   ```

All of these are protecting `socket.close()` calls. OSError covers the socket-related errors we want to suppress (socket already closed, broken pipe, etc.). We use specific exceptions so actual programming errors (TypeError, AttributeError, etc.) will surface.

Do NOT use bare `Exception` - that would still hide too much. OSError is the appropriate base for socket operations.
  </action>
  <verify>
Run: `python -c "import ast; ast.parse(open('open_protocol_emulator.py').read()); print('Syntax OK')"`
Then: `grep -n "except:" open_protocol_emulator.py` should return no matches (no bare except clauses remain).
  </verify>
  <done>All 5 bare `except:` replaced with `except OSError:` or `except (OSError, BrokenPipeError):`. No bare except clauses remain in codebase.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "import open_protocol_emulator"` - imports without error
- [ ] `grep -n "except:" open_protocol_emulator.py` - returns no matches
- [ ] Only one `_increment_vin` method exists (verify with `grep -n "_increment_vin" open_protocol_emulator.py`)
- [ ] VIN increment test passes: `python -c "from open_protocol_emulator import OpenProtocolEmulator; e = OpenProtocolEmulator(); e._increment_vin(); print(e.current_vin)"` outputs AB123001
</verification>

<success_criteria>

- Duplicate `_increment_vin()` method removed
- All 5 bare `except:` clauses replaced with specific exception types
- No syntax errors introduced
- VIN increment functionality works correctly
- No bare except clauses remain in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/01-technical-debt-cleanup/01-01-SUMMARY.md`
</output>
