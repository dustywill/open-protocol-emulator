---
phase: 04-multi-revision
plan: 03
type: execute
depends_on: ["04-01"]
files_modified: [open_protocol_emulator.py]
autonomous: true
---

<objective>
Implement multi-revision support for Tool Control MIDs (0040-0043).

Purpose: Enable MID 0041 (Tool Data) revisions 1-5 which add tool serial number, calibration date, and additional tool information.
Output: MID 0041 supports revisions 1-5 with proper field content based on request.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-revision/04-RESEARCH.md
@.planning/phases/04-multi-revision/04-01-SUMMARY.md
@open_protocol_emulator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tool information instance variables</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add instance variables for tool data (needed for MID 0041 revisions 2-5):
```python
# Tool information (for MID 0041)
self.tool_serial_number = "TOOL123456789012"  # 14 chars
self.tool_number_of_tightenings = 0           # Incremented with each tightening
self.tool_last_calib_date = "2025-01-01"      # YYYY-MM-DD (10 chars)
self.tool_controller_serial = self.ctrl_serial  # 10 chars, same as controller
self.tool_calib_value = 10000                  # Calibration torque * 100
self.tool_last_service_date = "2025-01-01"    # YYYY-MM-DD (10 chars)
self.tool_tightenings_since_service = 0
self.tool_type = 1                            # Tool type ID
self.tool_motor_size = 100                    # Motor size
self.tool_open_end_data = "                   "  # 20 chars (optional)
self.tool_controller_software_version = self.ctrl_sw_version  # 19 chars
```

Update send_single_tightening_result() to increment tool_number_of_tightenings and tool_tightenings_since_service.
  </action>
  <verify>Python syntax check passes</verify>
  <done>Tool data instance variables added</done>
</task>

<task type="auto">
  <name>Task 2: Implement MID 0040/0041 handler with multi-revision support</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add method to build MID 0041 response data:
```python
def _build_mid0041_data(self, revision: int) -> str:
    """Build MID 0041 Tool Data response for given revision (1-5)."""
    fields = []

    # Revision 1 fields (always included)
    fields.append(f"01{self.tool_serial_number.ljust(14)[:14]}")  # Tool serial (14 chars)
    fields.append(f"02{self.tool_number_of_tightenings:010d}")    # Total tightenings (10 digits)
    fields.append(f"03{self.tool_last_calib_date}")               # Last calib date (10 chars)
    fields.append(f"04{self.tool_controller_serial}")             # Controller serial (10 chars)

    if revision >= 2:
        fields.append(f"05{self.tool_calib_value:06d}")           # Calib value (6 digits)
        fields.append(f"06{self.tool_last_service_date}")         # Service date (10 chars)
        fields.append(f"07{self.tool_tightenings_since_service:010d}")  # Since service (10 digits)

    if revision >= 3:
        fields.append(f"08{self.tool_type:02d}")                  # Tool type (2 digits)
        fields.append(f"09{self.tool_motor_size:04d}")            # Motor size (4 digits)

    if revision >= 4:
        fields.append(f"10{self.tool_open_end_data}")             # Open end data (20 chars)

    if revision >= 5:
        fields.append(f"11{self.tool_controller_software_version}")  # Controller SW (19 chars)

    return "".join(fields)
```

Update or add MID 0040 handler in process_message():
```python
elif mid_int == 40:  # MID 0040 Tool data request
    requested_rev = int(rev) if rev.strip() else 1
    response_rev = self._get_response_revision(41, requested_rev)
    tool_data = self._build_mid0041_data(response_rev)
    resp = build_message(41, rev=response_rev, data=tool_data)
    self.send_to_client(resp)
    print(f"[Tool] Sent tool data (MID 0041 rev {response_rev})")
    return
```

Note: The existing MID 40/41 handlers treat them incorrectly as disable/enable commands (they're actually tool data request/reply). Keep the existing MID 0042/0043 handlers for disable/enable, but fix MID 0040 to be tool data request.
  </action>
  <verify>Python syntax check passes, send MID 0040 and receive MID 0041 with tool data</verify>
  <done>MID 0040/0041 handlers properly implemented with revision support</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile open_protocol_emulator.py` passes
- [ ] Emulator starts without errors
- [ ] MID 0040 with rev=1 returns MID 0041 rev 1 with basic tool data
- [ ] MID 0040 with rev=5 returns MID 0041 rev 5 with all fields
- [ ] Tool tightening counters increment correctly
- [ ] MID 0042/0043 (tool enable/disable) still work correctly
</verification>

<success_criteria>
- All tasks completed
- MID 0041 responds with correct revision based on request
- Tool counters track correctly
- No regressions in tool enable/disable functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-revision/04-03-SUMMARY.md`
</output>
