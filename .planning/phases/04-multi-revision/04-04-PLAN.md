---
phase: 04-multi-revision
plan: 04
type: execute
depends_on: ["04-01"]
files_modified: [open_protocol_emulator.py]
autonomous: true
---

<objective>
Implement multi-revision support for VIN MIDs (0050-0054).

Purpose: Enable MID 0052 revision 2 which adds 4-part identifier support for complex product tracking.
Output: MID 0052 supports revisions 1-2, VIN subscription tracks requested revision.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-revision/04-RESEARCH.md
@.planning/phases/04-multi-revision/04-01-SUMMARY.md
@open_protocol_emulator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 4-part identifier variables and subscription revision tracking</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add instance variables for 4-part identifier (revision 2) support:
```python
# VIN 4-part identifier (for MID 0052 revision 2)
self.identifier_part2 = ""  # Optional second part (25 chars)
self.identifier_part3 = ""  # Optional third part (25 chars)
self.identifier_part4 = ""  # Optional fourth part (25 chars)

# VIN subscription revision tracking
self.vin_subscribed_rev = 1  # Revision requested in MID 0051
```

Reset vin_subscribed_rev on disconnect in handle_client cleanup:
```python
self.vin_subscribed_rev = 1  # Reset to default
```
  </action>
  <verify>Python syntax check passes</verify>
  <done>4-part identifier variables and subscription tracking added</done>
</task>

<task type="auto">
  <name>Task 2: Implement MID 0052 multi-revision builder</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add method to build MID 0052 VIN data:
```python
def _build_mid0052_data(self, revision: int) -> str:
    """Build MID 0052 VIN data for given revision (1-2)."""
    if revision == 1:
        # Revision 1: Just VIN number, 25 chars, no field prefix
        return self.current_vin.ljust(25)[:25]

    elif revision >= 2:
        # Revision 2: 4-part identifier with field numbers
        fields = []
        fields.append(f"01{self.current_vin.ljust(25)[:25]}")        # VIN (part 1)
        fields.append(f"02{self.identifier_part2.ljust(25)[:25]}")   # Part 2
        fields.append(f"03{self.identifier_part3.ljust(25)[:25]}")   # Part 3
        fields.append(f"04{self.identifier_part4.ljust(25)[:25]}")   # Part 4
        return "".join(fields)

    return self.current_vin.ljust(25)[:25]  # Fallback to rev 1
```
  </action>
  <verify>Python syntax check passes</verify>
  <done>MID 0052 builder method implemented</done>
</task>

<task type="auto">
  <name>Task 3: Update VIN handlers to use revision-aware formatting</name>
  <files>open_protocol_emulator.py</files>
  <action>
Update MID 0051 handler (VIN subscribe) to:
1. Remove the revision rejection: `if req_rev > 1: resp = build_message(4, ...)`
2. Use revision negotiation: `subscribed_rev = self._get_response_revision(52, req_rev)`
3. Store the negotiated revision: `self.vin_subscribed_rev = subscribed_rev`
4. Send initial VIN with correct revision format

Update MID 0050 handler (VIN download) to use subscribed revision when sending VIN update:
```python
if self.vin_subscribed:
    vin_data = self._build_mid0052_data(self.vin_subscribed_rev)
    vin_msg = build_message(52, rev=self.vin_subscribed_rev, data=vin_data, no_ack=self.vin_no_ack)
    self.send_to_client(vin_msg)
```

Update _increment_vin() method to use subscribed revision:
```python
if self.vin_subscribed and self.session_active:
    vin_data = self._build_mid0052_data(self.vin_subscribed_rev)
    vin_msg = build_message(52, rev=self.vin_subscribed_rev, data=vin_data, no_ack=self.vin_no_ack)
    threading.Thread(target=self.send_to_client, args=(vin_msg,), daemon=True).start()
```

Update all other locations that send MID 0052 to use the builder and correct revision.
  </action>
  <verify>Subscribe with rev 1 and rev 2, verify MID 0052 format differs correctly</verify>
  <done>All VIN message sends use proper revision-aware formatting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile open_protocol_emulator.py` passes
- [ ] Emulator starts without errors
- [ ] MID 0051 with rev=1 → subsequent MID 0052 has 25-char VIN only
- [ ] MID 0051 with rev=2 → subsequent MID 0052 has 4-part identifier (100 chars + field prefixes)
- [ ] VIN download (MID 0050) triggers correct revision MID 0052
- [ ] VIN increment on batch complete sends correct revision MID 0052
- [ ] No regressions in VIN subscription/unsubscription
</verification>

<success_criteria>
- All tasks completed
- MID 0052 responds with correct revision based on subscription
- 4-part identifier fields included when revision 2 subscribed
- No regressions in VIN functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-revision/04-04-SUMMARY.md`
</output>
