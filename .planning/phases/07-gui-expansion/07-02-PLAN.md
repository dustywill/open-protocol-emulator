---
phase: 07-gui-expansion
plan: 02
type: execute
depends_on: ["07-01"]
files_modified: [open_protocol_emulator.py]
autonomous: false
---

<objective>
Implement profile management UI for selecting and managing controller profiles.

Purpose: Allow users to quickly switch between predefined controller profiles (legacy, pf6000-basic, pf6000-full) and save/load custom profiles via the GUI.
Output: Profile selection dropdown integrated into the Revision Configuration frame with save/load file dialog support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-revision-configuration/06-01-PLAN.md
@.planning/phases/06-revision-configuration/06-02-PLAN.md
@.planning/phases/07-gui-expansion/07-01-SUMMARY.md
@open_protocol_emulator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filedialog import and profile GUI variable</name>
  <files>open_protocol_emulator.py</files>
  <action>
1. Add filedialog import at the top of the file, after the existing tkinter imports (around line 8):

```python
from tkinter import filedialog
```

2. In `start_gui()`, add a profile selection variable after the revision configuration GUI variables added in Plan 07-01:

```python
# --- Profile GUI Variables ---
profile_var = tk.StringVar(value=self.get_current_profile())
# --- End Profile GUI Variables ---
```

This variable will be bound to the profile dropdown OptionMenu.

IMPORTANT: This task assumes Phase 6 Plan 02 has been executed and `self.get_current_profile()` and `self.get_available_profiles()` exist. If they don't exist, this plan will fail at runtime.
  </action>
  <verify>Python syntax check: `python -m py_compile open_protocol_emulator.py`</verify>
  <done>filedialog imported, profile_var StringVar added</done>
</task>

<task type="auto">
  <name>Task 2: Add profile selection dropdown to Revision Configuration frame</name>
  <files>open_protocol_emulator.py</files>
  <action>
Modify the Revision Configuration frame (created in Plan 07-01) to add a profile selection row. Add this at the beginning of the frame, before the MID spinboxes (shifting them down by one row):

Find the section starting with `# --- Revision Configuration Frame ---` and modify it:

```python
# --- Revision Configuration Frame ---
revision_frame = tk.LabelFrame(root, text="Revision Configuration", padx=5, pady=5)
revision_frame.pack(padx=10, pady=5, fill=tk.X)

# Row 0: Profile selection
tk.Label(revision_frame, text="Profile:").grid(row=0, column=0, sticky=tk.W, padx=2, pady=2)
profile_menu = tk.OptionMenu(revision_frame, profile_var, *self.get_available_profiles())
profile_menu.config(width=12)
profile_menu.grid(row=0, column=1, sticky=tk.W, padx=2, pady=2)
tk.Button(revision_frame, text="Apply Profile", command=apply_profile_selection).grid(row=0, column=2, padx=2, pady=2)
tk.Button(revision_frame, text="Save...", command=save_profile_to_file).grid(row=0, column=3, padx=2, pady=2)
tk.Button(revision_frame, text="Load...", command=load_profile_from_file).grid(row=0, column=4, padx=2, pady=2)

# Row 1: MID 0002 and MID 0004
tk.Label(revision_frame, text="MID 0002 (Comm Start):").grid(row=1, column=0, sticky=tk.W, padx=2, pady=2)
tk.Spinbox(revision_frame, from_=1, to=6, textvariable=rev_mid_0002_var, width=3).grid(row=1, column=1, sticky=tk.W, padx=2, pady=2)
tk.Label(revision_frame, text="MID 0004 (Error):").grid(row=1, column=2, sticky=tk.W, padx=2, pady=2)
tk.Spinbox(revision_frame, from_=1, to=3, textvariable=rev_mid_0004_var, width=3).grid(row=1, column=3, sticky=tk.W, padx=2, pady=2)

# Row 2: MID 0015 and MID 0041
tk.Label(revision_frame, text="MID 0015 (Pset):").grid(row=2, column=0, sticky=tk.W, padx=2, pady=2)
tk.Spinbox(revision_frame, from_=1, to=2, textvariable=rev_mid_0015_var, width=3).grid(row=2, column=1, sticky=tk.W, padx=2, pady=2)
tk.Label(revision_frame, text="MID 0041 (Tool Data):").grid(row=2, column=2, sticky=tk.W, padx=2, pady=2)
tk.Spinbox(revision_frame, from_=1, to=5, textvariable=rev_mid_0041_var, width=3).grid(row=2, column=3, sticky=tk.W, padx=2, pady=2)

# Row 3: MID 0052 and MID 0061
tk.Label(revision_frame, text="MID 0052 (VIN):").grid(row=3, column=0, sticky=tk.W, padx=2, pady=2)
tk.Spinbox(revision_frame, from_=1, to=2, textvariable=rev_mid_0052_var, width=3).grid(row=3, column=1, sticky=tk.W, padx=2, pady=2)
tk.Label(revision_frame, text="MID 0061 (Result):").grid(row=3, column=2, sticky=tk.W, padx=2, pady=2)
tk.Spinbox(revision_frame, from_=1, to=7, textvariable=rev_mid_0061_var, width=3).grid(row=3, column=3, sticky=tk.W, padx=2, pady=2)

# Apply revisions button (spans rows 1-3)
tk.Button(revision_frame, text="Apply Revisions", command=apply_revision_settings).grid(row=1, column=4, rowspan=3, padx=10, pady=2, sticky=tk.NS)
# --- End Revision Configuration Frame ---
```

Key changes:
- Added Row 0 with Profile dropdown, Apply Profile, Save..., and Load... buttons
- Shifted MID spinboxes to rows 1-3 (from rows 0-2)
- Moved Apply Revisions button to column 4, spanning rows 1-3
  </action>
  <verify>Python syntax check: `python -m py_compile open_protocol_emulator.py`</verify>
  <done>Profile selection row added with dropdown, Apply Profile, Save, and Load buttons</done>
</task>

<task type="auto">
  <name>Task 3: Implement profile management callbacks</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add three callback functions for profile management. Place these in the GUI Callbacks section, after the apply_revision_settings callback:

```python
def apply_profile_selection():
    """Apply the selected profile and update spinboxes."""
    selected_profile = profile_var.get()
    try:
        self.apply_profile(selected_profile)
        # Update spinboxes to reflect new values
        rev_mid_0002_var.set(str(self.revision_config.get(2, 6)))
        rev_mid_0004_var.set(str(self.revision_config.get(4, 3)))
        rev_mid_0015_var.set(str(self.revision_config.get(15, 2)))
        rev_mid_0041_var.set(str(self.revision_config.get(41, 5)))
        rev_mid_0052_var.set(str(self.revision_config.get(52, 2)))
        rev_mid_0061_var.set(str(self.revision_config.get(61, 7)))
        print(f"[GUI] Applied profile: {selected_profile}")
        print(f"  Description: {self.get_profile_description(selected_profile)}")
    except ValueError as e:
        messagebox.showerror("Error", str(e))

def save_profile_to_file():
    """Save current revision config to a JSON file."""
    filepath = filedialog.asksaveasfilename(
        defaultextension=".json",
        filetypes=[("JSON files", "*.json"), ("All files", "*.*")],
        title="Save Profile"
    )
    if filepath:
        try:
            profile_name = profile_var.get()
            if profile_name in self.DEFAULT_PROFILES:
                profile_name = "custom"  # Don't overwrite built-in names
            self.save_profile_to_file(filepath, profile_name)
            print(f"[GUI] Saved profile to: {filepath}")
            messagebox.showinfo("Success", f"Profile saved to {filepath}")
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save profile: {e}")

def load_profile_from_file():
    """Load revision config from a JSON file."""
    filepath = filedialog.askopenfilename(
        filetypes=[("JSON files", "*.json"), ("All files", "*.*")],
        title="Load Profile"
    )
    if filepath:
        try:
            loaded_name = self.load_profile_from_file(filepath)
            profile_var.set(loaded_name)
            # Update spinboxes to reflect loaded values
            rev_mid_0002_var.set(str(self.revision_config.get(2, 6)))
            rev_mid_0004_var.set(str(self.revision_config.get(4, 3)))
            rev_mid_0015_var.set(str(self.revision_config.get(15, 2)))
            rev_mid_0041_var.set(str(self.revision_config.get(41, 5)))
            rev_mid_0052_var.set(str(self.revision_config.get(52, 2)))
            rev_mid_0061_var.set(str(self.revision_config.get(61, 7)))
            print(f"[GUI] Loaded profile '{loaded_name}' from: {filepath}")
            messagebox.showinfo("Success", f"Profile '{loaded_name}' loaded")
        except FileNotFoundError:
            messagebox.showerror("Error", f"File not found: {filepath}")
        except ValueError as e:
            messagebox.showerror("Error", f"Invalid profile file: {e}")
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load profile: {e}")
```

These callbacks:
- apply_profile_selection: Applies a built-in profile and syncs spinboxes
- save_profile_to_file: Opens save dialog, saves current config as JSON
- load_profile_from_file: Opens file dialog, loads JSON and syncs spinboxes
  </action>
  <verify>
1. Python syntax check: `python -m py_compile open_protocol_emulator.py`
2. Verify callbacks exist: search for "def apply_profile_selection" in file
  </verify>
  <done>Three profile management callbacks implemented: apply_profile_selection, save_profile_to_file, load_profile_from_file</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Profile management UI with dropdown, Apply Profile, Save, and Load buttons</what-built>
  <how-to-verify>
    1. Run: `python open_protocol_emulator.py`
    2. Look for Profile dropdown in the Revision Configuration frame (should show "pf6000-full" by default)
    3. Change dropdown to "legacy" and click "Apply Profile"
    4. Verify all spinboxes update to 1 (legacy mode uses rev 1 for all MIDs)
    5. Change some spinbox values manually (e.g., MID 0061 to 3)
    6. Click "Save..." and save to a test file (e.g., test_profile.json)
    7. Change dropdown back to "pf6000-full", click "Apply Profile"
    8. Verify spinboxes update to full values (6, 3, 2, 5, 2, 7)
    9. Click "Load..." and load the test_profile.json you saved
    10. Verify spinboxes reflect the saved values (MID 0061 should be 3)
    11. Close the GUI (no errors should appear)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile open_protocol_emulator.py` passes
- [ ] filedialog imported at top of file
- [ ] Profile dropdown OptionMenu exists with 3 built-in profiles
- [ ] Apply Profile button applies selected profile and updates spinboxes
- [ ] Save button opens file dialog and saves JSON
- [ ] Load button opens file dialog and loads JSON, updates spinboxes
- [ ] GUI starts without errors
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Profile selection and management fully functional
- Save/load creates valid JSON files
- Human approved the visual layout and functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-gui-expansion/07-02-SUMMARY.md`
</output>
