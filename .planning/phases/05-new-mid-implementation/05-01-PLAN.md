---
phase: 05-new-mid-implementation
plan: 01
type: execute
depends_on: []
files_modified: [open_protocol_emulator.py]
autonomous: true
---

<objective>
Implement MID 0082 (Set Time) command handling using the registry-based dispatch pattern.

Purpose: Allow integrators to set the controller's internal time via Open Protocol, completing the time management functionality expected by integration systems.
Output: Working MID 0082 handler registered in mid_handlers dict, responding with MID 0005 acknowledgment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@open_protocol_emulator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add controller_time state variable</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add instance variable in __init__ (around line 130, in the state initialization section):

```python
self.controller_time = None  # Set via MID 0082
```

This stores the time string received from MID 0082. The emulator doesn't use this for actual timestamps (those use system time), but it provides protocol compliance for integrators that set controller time.
  </action>
  <verify>Code runs without syntax errors after adding variable.</verify>
  <done>controller_time instance variable exists in __init__.</done>
</task>

<task type="auto">
  <name>Task 2: Implement _handle_mid_0082 handler method</name>
  <files>open_protocol_emulator.py</files>
  <action>
Create handler method following the established handler signature pattern (mid_int, rev, no_ack_flag, data_field, msg).

Add after the last existing handler method (around line 740, after _handle_mid_0063):

```python
def _handle_mid_0082(self, mid_int: int, rev: str, no_ack_flag: str, data_field: str, msg: bytes):
    """MID 0082: Set Time - receive time from integrator."""
    time_str = data_field.strip()
    if len(time_str) == 19:
        try:
            datetime.datetime.strptime(time_str, "%Y-%m-%d:%H:%M:%S")
            self.controller_time = time_str
            resp = build_message(5, rev=1, data="0082")
            print(f"[Time] Controller time set to: {time_str}")
        except ValueError:
            error_data = self._build_mid0004_data(1, 82, 20)
            resp = build_message(4, rev=1, data=error_data)
            print(f"[Time] Invalid time format received: {time_str}")
    else:
        error_data = self._build_mid0004_data(1, 82, 20)
        resp = build_message(4, rev=1, data=error_data)
        print(f"[Time] Invalid time length received: {len(time_str)} chars (expected 19)")
    self.send_to_client(resp)
```

MID 0082 Format (Revision 1):
- Message sent by: Integrator
- Answer: MID 0005 Command accepted
- Data field: 19 ASCII characters in format YYYY-MM-DD:HH:MM:SS
- Error 20: Invalid data (wrong format or length)
  </action>
  <verify>Handler method exists with correct signature and logic.</verify>
  <done>_handle_mid_0082 method implemented with time validation and error handling.</done>
</task>

<task type="auto">
  <name>Task 3: Register MID 0082 handler in dispatch registry</name>
  <files>open_protocol_emulator.py</files>
  <action>
Add the MID 0082 handler to the mid_handlers dictionary in _register_mid_handlers() method (around line 188):

```python
82: self._handle_mid_0082,
```

Place it after the existing handlers, keeping numeric order if practical (after 63, before 9999).

The registry maps MID numbers to handler methods, so when process_message() receives MID 0082, it will call self._handle_mid_0082().
  </action>
  <verify>
Verify registration by checking that mid_handlers dict includes key 82.
Manual test: Send MID 0082 with valid time string "2026-01-16:14:30:00", verify MID 0005 response.
Manual test: Send MID 0082 with invalid time "invalid-time", verify MID 0004 response with error code 20.
  </verify>
  <done>
- MID 0082 handler registered in mid_handlers
- Valid time format accepted with MID 0005 response
- Invalid time format rejected with MID 0004 error
- Controller time stored in instance variable
- Log output shows time setting events
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Code runs without syntax errors
- [ ] MID 0082 handler follows registry-based dispatch pattern
- [ ] Time format validation works (accepts valid YYYY-MM-DD:HH:MM:SS, rejects invalid)
- [ ] Response messages use correct MID numbers and format
- [ ] Error response uses _build_mid0004_data helper for consistency
</verification>

<success_criteria>

- MID 0082 implemented per Open Protocol spec
- Integrator can set controller time
- Invalid requests properly rejected with MID 0004 error
- Handler follows established registry pattern
- No regressions to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-new-mid-implementation/05-01-SUMMARY.md`
</output>
